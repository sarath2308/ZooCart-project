<%- include("../../views/partials/user/header.ejs") %>

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__text">
          <h4>Check Out</h4>
          <div class="breadcrumb__links">
            <a href="./index.html">Home</a>
            <a href="./shop.html">Shop</a>
            <span>Check Out</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
  <div class="container">
    <div class="checkout__form">
      <form action="/orderSummary?cart=1" method="POST">
        <div class="row">
          <!-- Left Column: Addresses & Billing Details -->
          <div class="col-lg-8 col-md-6">
            <h6 class="checkout__title">Choose Delivery Address</h6>
            
            <!-- Address List -->
            <div class="address-container">
                <% addressData.forEach((ad) => { %>
                <div class="address-card <%= ad.default ? 'default' : '' %>" data-address-id="<%= ad._id %>">
                    <!-- The radio button will only be checked if this address is marked as default -->
                    <input type="radio" name="addressId" value="<%=ad._id%>"<% if (ad.default) { %> checked <% } %> class="default-radio">
                    <div class="address-details">
                        <h5> <%= ad.name %>
                            <% if (ad.default) { %>
                            <span class="default-badge">Default</span>
                            <% } %>
                        </h5>
                        <p style="color: grey;"><%= ad.addressType %></p>
                        <p><%= ad.city %>, <%= ad.landMark %>, <%= ad.state %></p>
                        <p>Pin: <%= ad.pincode %></p>
                        <p>Phone: <%= ad.phone %></p>
                        <p>Alt Phone: <%= ad.altPhone %></p>
                    </div>
                </div>
                <% }) %>
            </div>
            <br>
            <!-- Add New Address Button -->
            <div class="checkout__input add-address">
              <button type="button" class="btn btn-primary" onclick="showAddAddressForm()">
                <span class="icon_plus"></span> Add New Address
              </button>
                </div>
               <!-- Hidden Add Address Form -->
              <div id="addAddressForm" style="display:none; margin-top:20px;">
              <h6 class="checkout__title">Add New Address</h6>
              <div class="row">
                <div class="col-lg-6">
                  <div class="checkout__input">
                    <p>name<span>*</span></p>
                    <input type="text" id="name" name="name"placeholder="your name">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="checkout__input">
                    <p>landMark</p>
                    <input type="text" id="landmark" placeholder="shopping complex,park etc..">
                  </div>
                </div>
              </div>
              <div class="checkout__input">
                <p>City<span>*</span></p>
                <input type="text" id="city">
              </div>
              <div class="checkout__input">
                <p>State<span>*</span></p>
                <input type="text" id="state">
              </div>
              <div class="checkout__input">
                <p>Postcode/ZIP<span>*</span></p>
                <input type="text" id="pincode">
              </div>
              <div class="checkout__input">
                <p>phone<span>*</span></p>
                <input type="text" id="phone">
              </div>
              <div class="checkout__input">
                <p>Alternative phone<span>*</span></p>
                <input type="text" id="altPhone">
              </div>
              <div class="checkout__input">
                <button type="button" class="btn btn-success" onclick="saveAddress()">Save Address</button>
                <button type="button" class="btn btn-secondary" onclick="hideAddAddressForm()">Cancel</button>
              </div>
            </div>
          </div>
          
          <!-- Right Column: Coupon & Order Summary -->
          <div class="col-lg-4 col-md-6">
            <div class="checkout__coupon mb-4">
                <h6 class="coupon__code">
                  <span class="icon_tag_alt"></span> Have a coupon?
                </h6>
                <div class="row">
                  <div class="col-md-6">
                    <input type="text" id="coupon-code-input" name="coupon" class="form-control" placeholder="Enter coupon code">
                  </div>
                  <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                          Available Coupon
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                            <%couponData.forEach((cou)=>{%>
                                <%if(cou.minimumPrice<=grandTotal){%>
                            <li><a class="dropdown-item" href="#" onclick="selectCoupon('<%=cou.code%>'); return false;"><%=cou.code%>(₹<%=cou.offerPrice%> OFF)</a></li>
                            <%}%>
                            <%})%>
                        </ul>
                      </div>
                  </div>
                </div>
                <br>
                <button type="button" class="btn btn-success w-100" onclick="applyCoupon()">Apply Coupon</button>
                <div id="coupon-message" style="margin-top:10px;"></div>
              </div>
            
            <!-- Order Summary -->

  <div class="checkout__order">
    <h4 class="order__title">Your order</h4>
    <div class="checkout__order__products">Product <span>Total</span></div>
    <ul class="checkout__total__products" id="order-products">
      <% if (products && products.length > 0) { %>
        <% products.forEach(function(item, index) { %>
          <li>
            <%= index + 1 %>. <%= item.productDetails.productName %> <small>x<%= item.quantity %></small>
            <span>₹<%= item.productDetails.salePrice * item.quantity %></span>
          </li>
        <% }); %>
      <% } %>
    </ul>
    <ul class="checkout__total__all" id="order-totals">
      <li id="discount-li" style="color:green;">Discount <span style="color: green;">-₹<%= grandRegularTotal - grandTotal %></span></li>
      <li id="subtotal-li">Subtotal <span>₹<%= grandTotal %></span></li>
      <li id="total-li">Total Payable <span>₹<%= grandTotal %></span></li>
      <% if (couponApplied) { %>
        <li id="coupon-li">Coupon Applied (<%= appliedCoupon %>): <span>₹<%= couponOfferPrice %> OFF</span></li>
      <% } %>
    </ul>
    <button type="submit" class="site-btn">PLACE ORDER</button>
  </div>
            
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
<!-- Checkout Section End -->

<%- include("../../views/partials/user/footer.ejs") %>

<style>
  /* Adjust radio buttons (make them smaller) */
  input[type="radio"] {
    width: 15px;
    height: 15px;
    margin-right: 5px;
    vertical-align: middle;
  }
  /* Increase the address card size */
  .address-item {
    padding: 20px;
    font-size: 1rem;
  }
  .address-details {
    display: inline-block;
    vertical-align: middle;
  }
  /* Adjust default badge styling if needed */
  .default-badge {
    background: #007bff;
    color: #fff;
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 3px;
    margin-left: 8px;
  }
  .address-container {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* Address Card */
.address-card {
    background: #fff;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    transition: transform 0.2s ease-in-out;
}

.address-card:hover {
    transform: scale(1.02);
}

/* Default Address Styling */
.default {
    border: 2px solid #007bff;
    background: #f0f8ff;
}

/* Default Badge */
.default-badge {
    background: #007bff;
    color: white;
    font-size: 12px;
    padding: 3px 8px;
    border-radius: 5px;
    margin-left: 8px;
}

/* Radio Button */
.default-radio {
    transform: scale(1.2);
    margin-right: 10px;
}

/* Address Details */
.address-details h5 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.address-details p {
    margin: 3px 0;
    font-size: 0.9rem;
    color: #555;
}

</style>

<script>
  // Toggle display of add address form
  function showAddAddressForm() {
    document.getElementById('addAddressForm').style.display = 'block';
  }
  function hideAddAddressForm() {
    document.getElementById('addAddressForm').style.display = 'none';
  }
//save addresss

function saveAddress() {
  // Collect field values from the form
  const name = $('#name').val().trim();
  const landmark = $('#landmark').val().trim();
  const city = $('#city').val().trim();
  const state = $('#state').val().trim();
  const pincode = $('#pincode').val().trim();
  const phone = $('#phone').val().trim();
  const altPhone = $('#altPhone').val().trim();
  
  // Regular expression for a 6-digit pincode
  const pincodeRegex = /^\d{6}$/;
  // Regular expression for a valid phone number (example: 10 digits, modify as needed)
  const phoneRegex = /^\d{10}$/;
  
  // Validate required fields
  if (!name || !city || !state || !pincode || !phone) {
    Swal.fire({
      icon: 'error',
      title: 'Validation Error',
      text: 'Please fill in all the required fields.'
    });
    return;
  }
  
  // Validate pincode (should be 6 digits)
  if (!pincodeRegex.test(pincode)) {
    Swal.fire({
      icon: 'error',
      title: 'Invalid Pincode',
      text: 'Please enter a valid 6-digit pincode.'
    });
    return;
  }
  
  // Validate phone numbers (modify phoneRegex if your requirements differ)
  if (!phoneRegex.test(phone)) {
    Swal.fire({
      icon: 'error',
      title: 'Invalid Phone Number',
      text: 'Please enter a valid 10-digit phone number.'
    });
    return;
  }
  
  // Optionally, you can validate altPhone if provided
  if (altPhone && !phoneRegex.test(altPhone)) {
    Swal.fire({
      icon: 'error',
      title: 'Invalid Alternate Phone Number',
      text: 'Please enter a valid 10-digit alternate phone number.'
    });
    return;
  }
  
  // Build the data object
  const addressData = {
    addressType:"Home",
    name: name,
    landMark: landmark,  // using schema field "landMark"
    city: city,
    state: state,
    pincode: pincode,
    phone: phone,
    altPhone: altPhone,
    default:false,

    };

  // Send the data via AJAX POST
  $.ajax({
    url: '/save-address',   // adjust this endpoint to match your backend route
    type: 'POST',
    data:{addressData:addressData},
    success: function(response) {
      if (response.success) {
        Swal.fire({
          icon: 'success',
          title: 'Address Saved',
          text: 'Your address has been saved successfully!'
        }).then(() => {
          hideAddAddressForm();
          location.reload();
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: response.message || 'Error saving address'
        });
      }
    },
    error: function(err) {
      console.error("Error saving address:", err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'An error occurred while saving your address. Please try again later.'
      });
    }
  });
}




  function selectCoupon(code) {
    // Set the coupon code input value when a coupon is selected.
    document.getElementById('coupon-code-input').value = code;
  }

  function applyCoupon() {
    var couponCode = document.getElementById('coupon-code-input').value.trim();
    if (!couponCode) {
      document.getElementById('coupon-message').innerHTML = "<span class='text-danger'>Please enter a coupon code.</span>";
      return;
    }
    
    // AJAX call to send the coupon to the backend for validation and recalculation.
    $.ajax({
      url: '/apply-coupon',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ couponCode: couponCode, cart: true }),  // You may include more data if needed.
      success: function(response) {
        if (response.success) {
          // Update the order summary fields with new totals and coupon details.
          // Adjust property names as per your backend response.
          $('#order-totals').html(`
          <li id="discount-li" style="color: green; font-weight: bold;">Discount <span style="float: right;">-₹${response.grandRegularTotal - response.grandTotal}</span></li>
          <li id="coupon-li" style="color: green; font-weight: bold;">Coupon Applied <span style="float: right;color: green; ">-₹${response.couponOfferPrice} OFF</span></li>
          <li id="subtotal-li">Subtotal <span style="float: right;">₹${response.grandTotal}</span></li>
          <li id="total-li">Total Payable <span style="float: right;">₹${response.grandTotal}</span></li>
          `);
          $('#coupon-message').html("<span class='text-success'>Coupon '" + couponCode + "' applied successfully!</span>");
        } else {
          $('#coupon-message').html("<span class='text-danger'>" + response.message + "</span>");
        }
      },
      error: function(err) {
        console.error("Error applying coupon:", err);
        $('#coupon-message').html("<span class='text-danger'>Error applying coupon. Please try again later.</span>");
      }
    });
  }

</script>
<div class="accordion" id="checkoutAccordion">
  <!-- Section 1: Delivery Address -->
  <div class="accordion-item" id="section-address">
    <h2 class="accordion-header" id="headingAddress">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddress" aria-expanded="true" aria-controls="collapseAddress">
        1. Choose Delivery Address
        <span class="completed-badge d-none" id="address-completed">Completed</span>
      </button>
    </h2>
    <div id="collapseAddress" class="accordion-collapse collapse show" aria-labelledby="headingAddress" data-bs-parent="#checkoutAccordion">
      <div class="accordion-body">
        <!-- Address List -->
        <div class="address-container">
          <% addressData.forEach((ad) => { %>
            <div class="address-card <%= ad.default ? 'default' : '' %>" data-address-id="<%= ad._id %>">
              <input type="radio" name="addressId" value="<%= ad._id %>" <% if (ad.default) { %> checked <% } %> class="default-radio">
              <div class="address-details">
                <h5>
                  <%= ad.name %>
                  <% if (ad.default) { %>
                    <span class="default-badge">Default</span>
                  <% } %>
                </h5>
                <p style="color: grey;"><%= ad.addressType %></p>
                <p><%= ad.city %>, <%= ad.landMark %>, <%= ad.state %></p>
                <p>Pin: <%= ad.pincode %></p>
                <p>Phone: <%= ad.phone %></p>
                <p>Alt Phone: <%= ad.altPhone %></p>
              </div>
            </div>
          <% }); %>
        </div>
        <br>
        <!-- Add New Address Button -->
        <div class="checkout__input add-address">
          <button type="button" class="btn btn-primary" onclick="showAddAddressForm()">
            <span class="icon_plus"></span> Add New Address
          </button>
        </div>
        <!-- Hidden Add Address Form -->
        <div id="addAddressForm" style="display:none; margin-top:20px;">
          <h6 class="checkout__title">Add New Address</h6>
          <div class="row">
            <div class="col-lg-6">
              <div class="checkout__input">
                <p>Name<span>*</span></p>
                <input type="text" id="name" name="name" placeholder="Your name">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="checkout__input">
                <p>LandMark</p>
                <input type="text" id="landmark" placeholder="Shopping complex, park, etc.">
              </div>
            </div>
          </div>
          <div class="checkout__input">
            <p>City<span>*</span></p>
            <input type="text" id="city">
          </div>
          <div class="checkout__input">
            <p>State<span>*</span></p>
            <input type="text" id="state">
          </div>
          <div class="checkout__input">
            <p>Postcode/ZIP<span>*</span></p>
            <input type="text" id="pincode">
          </div>
          <div class="checkout__input">
            <p>Phone<span>*</span></p>
            <input type="text" id="phone">
          </div>
          <div class="checkout__input">
            <p>Alternative Phone<span>*</span></p>
            <input type="text" id="altPhone">
          </div>
          <div class="checkout__input">
            <button type="button" class="btn btn-success" onclick="saveAddress()">Save Address</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddAddressForm()">Cancel</button>
          </div>
        </div>
        <!-- Mark as Complete Button for Delivery Address -->
        <button type="button" class="btn btn-success mt-3" onclick="markComplete('section-address', 'address-completed')">Confirm & save</button>
      </div>
    </div>
  </div>
  <!-- Section 2: Payment Method -->
  <div class="accordion-item" id="section-payment">
    <h2 class="accordion-header" id="headingPayment">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePayment" aria-expanded="false" aria-controls="collapsePayment">
         Payment Method
        <span class="completed-badge d-none" id="payment-completed">Completed</span>
      </button>
    </h2>
    <div id="collapsePayment" class="accordion-collapse collapse" aria-labelledby="headingPayment" data-bs-parent="#checkoutAccordion">
      <div class="accordion-body">
        <p>Select your payment method:</p>

        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentOption" id="pay1" value="Razo Pay">
          <label class="form-check-label" for="pay2">RazorPay</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentOption" id="pay2" value="Cash on Delivery">
          <label class="form-check-label" for="pay3">Cash on Delivery</label>
        </div>
        <!-- Mark as Complete Button for Payment -->
        <button type="button" class="btn btn-success mt-3" onclick="markComplete('section-payment', 'payment-completed')">Mark as Complete</button>
      </div>
    </div>
  </div>
  <!-- Section 3: Order Summary -->
  <div class="accordion-item" id="section-summary">
    <h2 class="accordion-header" id="headingSummary">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary" aria-expanded="false" aria-controls="collapseSummary">
         Order Summary
        <span class="completed-badge d-none" id="summary-completed">Completed</span>
      </button>
    </h2>
    <div id="collapseSummary" class="accordion-collapse collapse" aria-labelledby="headingSummary" data-bs-parent="#checkoutAccordion">
      <div class="accordion-body">
        <div class="shopping__cart__table">
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <% if (products.length > 0) { %>
                <% products.forEach(pr => { %>
                  <tr data-item-id="<%= pr._id %>">
                    <td class="product__cart__item">
                      <div class="product__cart__item__pic">
                          <a href="/productDetails?id=<%=pr.productDetails._id%>" class="btn">
                        <img src="/uploads/re-image/<%= pr.productDetails.productImage[0] %>" alt="Product Image">
                        </a>
                      </div>
                      <div class="product__cart__item__text">
                        <h6><%= pr.productDetails.productName %></h6>

                        <h6 style="color:green">
                          <s style="font-size: 13px; color: grey;">₹<%= pr.productDetails.regularPrice %></s>
                          ₹<%= pr.productDetails.salePrice %>.0
                        </h6>
                      </div>
                    </td>
                    <td class="quantity__item">
                      <div class="quantity">
                         
                        <p>x<%=pr.quantity%></p>
                  
                        </div>
                    </td>
                    <td class="cart__price">
                      <span id="item-total-<%= pr.productDetails._id %>">₹<%= pr.productDetails.salePrice * pr.quantity %></span>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="4" class="text-center">
                    <p class="lead mb-4">No items found in Cart</p>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <!-- Mark as Complete Button for Order Summary -->
        <button type="button" class="btn btn-success mt-3" onclick="markComplete('section-summary', 'summary-completed')">Confirm</button>
      </div>
    </div>
  </div>
</div>